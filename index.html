<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Productivity Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Library for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Library for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        /* Style for the date picker to match the dark theme */
        input[type="date"], select {
            background-color: #4a5568;
            color: #e2e8f0;
            border: 1px solid #718096;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        .dashboard-toggle-btn.active {
            background-color: #4f46e5;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- Header -->
        <header class="text-center mb-4">
            <h1 class="text-4xl font-bold text-white">Productivity Tracker</h1>
            <p class="text-gray-400 mt-2">Log your activities, track your history, and visualize your progress.</p>
        </header>

        <!-- Profile and Global Controls -->
        <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-8 flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <label for="profile-selector" class="font-semibold">Profile:</label>
                <select id="profile-selector"></select>
                <button id="add-profile-btn" class="text-sm bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-md transition-colors" title="Add New Profile">+</button>
                <button id="delete-profile-btn" class="text-sm bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded-md transition-colors" title="Delete Current Profile">&ndash;</button>
            </div>
            <div class="flex items-center gap-3">
                <button id="import-all-btn" class="text-sm bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1 px-3 rounded-md transition-colors">Import Backup</button>
                <button id="export-all-btn" class="text-sm bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded-md transition-colors">Export All Data</button>
                <input type="file" id="import-all-input" class="hidden" accept=".json">
            </div>
        </div>


        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">

            <!-- Left Column: Input & Summary -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Input Form -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Log Activity</h2>
                    <form id="log-form" class="space-y-4">
                        <div>
                            <label for="activity" class="block text-sm font-medium text-gray-400">Activity Description</label>
                            <input type="text" id="activity" name="activity" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="start-time" class="block text-sm font-medium text-gray-400">Start Time</label>
                                <input type="time" id="start-time" name="start-time" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                            </div>
                            <div>
                                <label for="end-time" class="block text-sm font-medium text-gray-400">End Time</label>
                                <input type="time" id="end-time" name="end-time" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                            </div>
                        </div>
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-400">Category</label>
                            <select id="category" name="category" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                                <option value="deep-work">Deep Work (Study, etc.)</option>
                                <option value="shallow-work">Shallow Work (Planning, Email)</option>
                                <option value="leisure">Scheduled Leisure (Gaming, etc.)</option>
                                <option value="break">Scheduled Break (Rest, Lunch)</option>
                                <option value="distraction">Distraction (Unplanned browsing)</option>
                                <option value="rabbit-hole">Distraction (Rabbit Hole)</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 shadow-md">Add to Log</button>
                    </form>
                </div>

                <!-- Summary Dashboard -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-white">Daily Summary</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center bg-gray-700 p-4 rounded-lg">
                            <span class="font-bold text-lg">Productivity Score:</span>
                            <span id="total-score" class="text-3xl font-bold text-indigo-400">0</span>
                        </div>
                        <div id="summary-details" class="space-y-2 text-sm">
                            <!-- Summary details will be injected here by JS -->
                        </div>
                        <div class="border-t border-gray-700 pt-4 flex space-x-2">
                            <button id="export-csv" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-md text-sm transition duration-300">Export Day (CSV)</button>
                            <button id="export-md" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-md text-sm transition duration-300">Copy Day (MD)</button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Column: Activity Log -->
            <div class="lg:col-span-3 bg-gray-800 p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h2 id="log-title" class="text-2xl font-semibold text-white">Log for Today</h2>
                     <input type="date" id="date-picker">
                    <div class="flex items-center space-x-2">
                        <button id="import-btn" class="text-sm bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1 px-3 rounded-md transition-colors">Import Day...</button>
                        <button id="clear-log" class="text-sm text-red-400 hover:text-red-500 transition-colors font-semibold">Clear Day</button>
                        <input type="file" id="import-file-input" class="hidden" accept=".csv, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700/50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Time</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Duration</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Activity</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Category</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">Points</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider"></th>
                            </tr>
                        </thead>
                        <tbody id="log-table-body" class="divide-y divide-gray-700">
                             <tr id="empty-row">
                                <td colspan="6" class="text-center py-10 text-gray-500">Your logged activities will appear here.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div id="analytics-dashboard" class="mt-8 bg-gray-800 p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                <h2 class="text-2xl font-semibold text-white">Analytics Dashboard</h2>
                <div class="flex rounded-lg bg-gray-700 p-1">
                    <button id="weekly-btn" class="dashboard-toggle-btn px-4 py-1 text-sm font-semibold rounded-md transition-colors">This Week</button>
                    <button id="monthly-btn" class="dashboard-toggle-btn px-4 py-1 text-sm font-semibold rounded-md transition-colors">This Month</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                <div class="bg-gray-700 p-4 rounded-lg">
                    <div class="text-sm text-gray-400">Avg. Daily Score</div>
                    <div id="avg-score" class="text-2xl font-bold text-indigo-400">0.0</div>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <div class="text-sm text-gray-400">Total Productive Time</div>
                    <div id="total-productive-time" class="text-2xl font-bold text-green-400">0h 0m</div>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <div class="text-sm text-gray-400">Total Distraction Time</div>
                    <div id="total-distraction-time" class="text-2xl font-bold text-red-400">0h 0m</div>
                </div>
            </div>
            <div>
                <canvas id="analytics-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Modals (Edit, Markdown) -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg space-y-4">
             <h3 class="text-xl font-semibold text-white">Edit Log Entry</h3>
            <form id="edit-form" class="space-y-4">
                <input type="hidden" id="edit-entry-id">
                <div>
                    <label for="edit-activity" class="block text-sm font-medium text-gray-400">Activity Description</label>
                    <input type="text" id="edit-activity" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-start-time" class="block text-sm font-medium text-gray-400">Start Time</label>
                        <input type="time" id="edit-start-time" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                    </div>
                    <div>
                        <label for="edit-end-time" class="block text-sm font-medium text-gray-400">End Time</label>
                        <input type="time" id="edit-end-time" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                    </div>
                </div>
                <div>
                    <label for="edit-category" class="block text-sm font-medium text-gray-400">Category</label>
                    <select id="edit-category" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-white p-2">
                        <option value="deep-work">Deep Work (Study, etc.)</option>
                        <option value="shallow-work">Shallow Work (Planning, Email)</option>
                        <option value="leisure">Scheduled Leisure (Gaming, etc.)</option>
                        <option value="break">Scheduled Break (Rest, Lunch)</option>
                        <option value="distraction">Distraction (Unplanned browsing)</option>
                        <option value="rabbit-hole">Distraction (Rabbit Hole)</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancel-edit-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition">Cancel</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    <div id="markdown-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl space-y-4">
            <h3 class="text-xl font-semibold text-white">Export as Markdown</h3>
            <textarea id="markdown-output" readonly class="w-full h-64 bg-gray-900 text-gray-300 font-mono text-sm p-3 rounded-md border border-gray-700 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            <div class="flex justify-end space-x-3">
                <button id="copy-md-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition">Copy to Clipboard</button>
                <button id="close-modal-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition">Close</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL STATE & CONFIG ---
            let appData = {};
            let currentDate = getTodayDateString();
            let analyticsChart = null;
            let currentDashboardView = 'weekly';

            const CATEGORY_STYLES = {
                'deep-work': { label: 'Deep Work', color: 'rgba(74, 222, 128, 0.7)', pointsPerMin: 10 / 30 },
                'shallow-work': { label: 'Shallow Work', color: 'rgba(250, 204, 21, 0.7)', pointsPerMin: 4 / 30 },
                'leisure': { label: 'Leisure', color: 'rgba(96, 165, 250, 0.7)', pointsPerMin: 2 / 30 },
                'break': { label: 'Break', color: 'rgba(56, 189, 248, 0.7)', pointsPerMin: 2 / 30 },
                'distraction': { label: 'Distraction', color: 'rgba(248, 113, 113, 0.7)', pointsPerMin: -5 / 30 },
                'rabbit-hole': { label: 'Rabbit Hole', color: 'rgba(192, 132, 252, 0.7)', pointsPerMin: -10 / 30 }
            };
            const CATEGORY_REVERSE_MAP = Object.entries(CATEGORY_STYLES).reduce((acc, [key, value]) => {
                acc[value.label.toLowerCase()] = key;
                return acc;
            }, {});
            const STORAGE_KEY = 'productivityTrackerProfiles';

            // --- DOM ELEMENT SELECTORS ---
            const form = document.getElementById('log-form');
            const logTableBody = document.getElementById('log-table-body');
            const totalScoreEl = document.getElementById('total-score');
            const summaryDetailsEl = document.getElementById('summary-details');
            const emptyRow = document.getElementById('empty-row');
            const exportCsvBtn = document.getElementById('export-csv');
            const exportMdBtn = document.getElementById('export-md');
            const clearLogBtn = document.getElementById('clear-log');
            const importBtn = document.getElementById('import-btn');
            const importFileInput = document.getElementById('import-file-input');
            const datePicker = document.getElementById('date-picker');
            const logTitle = document.getElementById('log-title');
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const markdownModal = document.getElementById('markdown-modal');
            const markdownOutput = document.getElementById('markdown-output');
            const copyMdBtn = document.getElementById('copy-md-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const weeklyBtn = document.getElementById('weekly-btn');
            const monthlyBtn = document.getElementById('monthly-btn');
            const avgScoreEl = document.getElementById('avg-score');
            const totalProductiveTimeEl = document.getElementById('total-productive-time');
            const totalDistractionTimeEl = document.getElementById('total-distraction-time');
            const chartCanvas = document.getElementById('analytics-chart');
            const profileSelector = document.getElementById('profile-selector');
            const addProfileBtn = document.getElementById('add-profile-btn');
            const deleteProfileBtn = document.getElementById('delete-profile-btn');
            const importAllBtn = document.getElementById('import-all-btn');
            const exportAllBtn = document.getElementById('export-all-btn');
            const importAllInput = document.getElementById('import-all-input');

            // --- INITIALIZATION ---
            function initialize() {
                loadAppData();
                datePicker.value = currentDate;
                render();
                addEventListeners();
            }

            function addEventListeners() {
                form.addEventListener('submit', e => { e.preventDefault(); addActivity(); });
                logTableBody.addEventListener('click', handleLogTableClick);
                editForm.addEventListener('submit', e => { e.preventDefault(); saveEdit(); });
                cancelEditBtn.addEventListener('click', () => editModal.classList.add('hidden'));
                clearLogBtn.addEventListener('click', clearCurrentLog);
                datePicker.addEventListener('change', handleDateChange);
                importBtn.addEventListener('click', () => importFileInput.click());
                importFileInput.addEventListener('change', handleFileImport);
                exportCsvBtn.addEventListener('click', exportToCSV);
                exportMdBtn.addEventListener('click', showMarkdownModal);
                closeModalBtn.addEventListener('click', () => markdownModal.classList.add('hidden'));
                copyMdBtn.addEventListener('click', copyMarkdownToClipboard);
                weeklyBtn.addEventListener('click', () => setDashboardView('weekly'));
                monthlyBtn.addEventListener('click', () => setDashboardView('monthly'));
                profileSelector.addEventListener('change', switchProfile);
                addProfileBtn.addEventListener('click', addNewProfile);
                deleteProfileBtn.addEventListener('click', deleteCurrentProfile);
                importAllBtn.addEventListener('click', () => importAllInput.click());
                importAllInput.addEventListener('change', importAllData);
                exportAllBtn.addEventListener('click', exportAllData);
            }

            // --- DATA & PROFILE MANAGEMENT ---
            function saveAppData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }
            function loadAppData() {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    appData = JSON.parse(savedData);
                } else {
                    // First time setup
                    appData = {
                        currentProfile: 'Default',
                        profiles: {
                            'Default': {}
                        }
                    };
                    saveAppData();
                }
            }
            function getCurrentProfileLogs() {
                return appData.profiles[appData.currentProfile] || {};
            }
            function switchProfile() {
                appData.currentProfile = profileSelector.value;
                saveAppData();
                render();
            }
            function addNewProfile() {
                const profileName = prompt('Enter a name for the new profile:');
                if (profileName && !appData.profiles[profileName]) {
                    appData.profiles[profileName] = {};
                    appData.currentProfile = profileName;
                    saveAppData();
                    render();
                } else if (profileName) {
                    alert('A profile with this name already exists.');
                }
            }
            function deleteCurrentProfile() {
                const profileToDelete = appData.currentProfile;
                if (Object.keys(appData.profiles).length <= 1) {
                    alert('Cannot delete the last profile.');
                    return;
                }
                if (confirm(`Are you sure you want to delete the "${profileToDelete}" profile and all its data? This cannot be undone.`)) {
                    delete appData.profiles[profileToDelete];
                    appData.currentProfile = Object.keys(appData.profiles)[0]; // Switch to the first available profile
                    saveAppData();
                    render();
                }
            }

            // --- DATE & TIME UTILITIES ---
            function getTodayDateString() {
                const today = new Date();
                return new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            }
            function formatDuration(minutes, showZero = false) {
                if (minutes === 0 && !showZero) return '0m';
                const h = Math.floor(minutes / 60);
                const m = Math.floor(minutes % 60);
                let result = '';
                if (h > 0) result += `${h}h `;
                if (m > 0 || h === 0) result += `${m}m`;
                return result.trim();
            }

            // --- EVENT HANDLERS ---
            function handleLogTableClick(e) {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if (editBtn) openEditModal(Number(editBtn.dataset.id));
                else if (deleteBtn) deleteActivity(Number(deleteBtn.dataset.id));
            }
            function handleDateChange() { currentDate = datePicker.value; render(); }
            function setDashboardView(view) { currentDashboardView = view; render(); }

            // --- CORE LOGIC (ADD, EDIT, DELETE) ---
            function addActivity() {
                const newEntry = createEntryFromForm(form);
                if (!newEntry) return;
                const allLogs = getCurrentProfileLogs();
                if (!allLogs[currentDate]) allLogs[currentDate] = [];
                allLogs[currentDate].push(newEntry);
                allLogs[currentDate].sort((a, b) => a.startTime.localeCompare(b.startTime));
                saveAppData();
                render();
                form.reset();
                form.activity.focus();
            }
            function saveEdit() {
                const allLogs = getCurrentProfileLogs();
                const id = Number(document.getElementById('edit-entry-id').value);
                const entryIndex = allLogs[currentDate]?.findIndex(e => e.id === id);
                if (entryIndex === -1) return;
                const updatedEntry = createEntryFromForm(editForm, id);
                if (!updatedEntry) return;
                allLogs[currentDate][entryIndex] = updatedEntry;
                allLogs[currentDate].sort((a, b) => a.startTime.localeCompare(b.startTime));
                saveAppData();
                render();
                editModal.classList.add('hidden');
            }
            function deleteActivity(id) {
                const allLogs = getCurrentProfileLogs();
                if (!allLogs[currentDate]) return;
                allLogs[currentDate] = allLogs[currentDate].filter(entry => entry.id !== id);
                if (allLogs[currentDate].length === 0) delete allLogs[currentDate];
                saveAppData();
                render();
            }
            function clearCurrentLog() {
                if (confirm(`Are you sure you want to clear all entries for ${currentDate}?`)) {
                    const allLogs = getCurrentProfileLogs();
                    delete allLogs[currentDate];
                    saveAppData();
                    render();
                }
            }
            function createEntryFromForm(formElement, id = null) {
                const activity = formElement.querySelector('[id*="-activity"]').value;
                const startTime = formElement.querySelector('[id*="-start-time"]').value;
                const endTime = formElement.querySelector('[id*="-end-time"]').value;
                const category = formElement.querySelector('[id*="-category"]').value;
                if (!activity || !startTime || !endTime || !category) return null;
                const start = new Date(`1970-01-01T${startTime}`);
                const end = new Date(`1970-01-01T${endTime}`);
                if (end <= start) return null;
                const duration = (end - start) / (1000 * 60);
                const points = duration * CATEGORY_STYLES[category].pointsPerMin;
                return { id: id || Date.now(), activity, startTime, endTime, duration, category, points };
            }

            // --- RENDER FUNCTIONS ---
            function render() {
                const allLogs = getCurrentProfileLogs();
                const currentLog = allLogs[currentDate] || [];
                renderProfileSelector();
                updateLogTitle();
                renderLogTable(currentLog);
                renderDailySummary(currentLog);
                renderDashboard();
            }
            function renderProfileSelector() {
                profileSelector.innerHTML = '';
                Object.keys(appData.profiles).forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    if (name === appData.currentProfile) {
                        option.selected = true;
                    }
                    profileSelector.appendChild(option);
                });
            }
            function updateLogTitle() {
                logTitle.textContent = currentDate === getTodayDateString() ? "Log for Today" : `Log for ${currentDate}`;
            }
            function renderLogTable(log) {
                logTableBody.innerHTML = '';
                if (log.length === 0) { logTableBody.appendChild(emptyRow); return; }
                log.forEach(entry => {
                    const tr = document.createElement('tr');
                    tr.classList.add('hover:bg-gray-700/50', 'transition-colors');
                    const categoryStyle = CATEGORY_STYLES[entry.category];
                    tr.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${entry.startTime} - ${entry.endTime}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${formatDuration(entry.duration)}</td>
                        <td class="px-4 py-3 whitespace-nowrap font-medium">${entry.activity}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" style="background-color:${categoryStyle.color}; color: white;">${categoryStyle.label}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-bold ${entry.points > 0 ? 'text-green-400' : 'text-red-400'}">${entry.points.toFixed(1)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button data-id="${entry.id}" class="edit-btn text-gray-400 hover:text-indigo-400 transition-colors" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" /></svg></button>
                            <button data-id="${entry.id}" class="delete-btn text-gray-400 hover:text-red-500 transition-colors" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </td>
                    `;
                    logTableBody.appendChild(tr);
                });
            }
            function renderDailySummary(log) {
                totalScoreEl.textContent = log.reduce((sum, entry) => sum + entry.points, 0).toFixed(1);
                const summary = {};
                log.forEach(entry => { summary[entry.category] = (summary[entry.category] || 0) + entry.duration; });
                summaryDetailsEl.innerHTML = Object.values(CATEGORY_STYLES).map(catStyle => {
                    const time = summary[Object.keys(CATEGORY_STYLES).find(key => CATEGORY_STYLES[key].label === catStyle.label)] || 0;
                    if (time === 0) return '';
                    return `<div class="flex justify-between items-center">
                        <div class="flex items-center"><span class="h-3 w-3 rounded-full mr-2" style="background-color:${catStyle.color};"></span><span>${catStyle.label}</span></div>
                        <span class="font-semibold">${formatDuration(time)}</span>
                    </div>`;
                }).join('');
            }

            // --- ANALYTICS DASHBOARD LOGIC ---
            function renderDashboard() {
                weeklyBtn.classList.toggle('active', currentDashboardView === 'weekly');
                monthlyBtn.classList.toggle('active', currentDashboardView === 'monthly');
                const { startDate, endDate } = getDashboardDateRange();
                const stats = aggregateStatsForPeriod(startDate, endDate);
                avgScoreEl.textContent = stats.averageScore.toFixed(1);
                totalProductiveTimeEl.textContent = formatDuration(stats.productiveTime, true);
                totalDistractionTimeEl.textContent = formatDuration(stats.distractionTime, true);
                renderAnalyticsChart(stats.categoryTotals);
            }
            function getDashboardDateRange() {
                const today = new Date(currentDate + 'T00:00:00');
                let startDate, endDate;
                if (currentDashboardView === 'weekly') {
                    const dayOfWeek = today.getDay();
                    const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(today.setDate(diff));
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                } else {
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                }
                return { startDate, endDate };
            }
            function aggregateStatsForPeriod(startDate, endDate) {
                let totalMinutes = {};
                let totalScore = 0;
                let daysWithLogs = 0;
                const allLogs = getCurrentProfileLogs();
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayLog = allLogs[dateStr];
                    if (dayLog && dayLog.length > 0) {
                        daysWithLogs++;
                        totalScore += dayLog.reduce((sum, e) => sum + e.points, 0);
                        dayLog.forEach(entry => {
                            totalMinutes[entry.category] = (totalMinutes[entry.category] || 0) + entry.duration;
                        });
                    }
                }
                const productiveTime = (totalMinutes['deep-work'] || 0) + (totalMinutes['shallow-work'] || 0);
                const distractionTime = (totalMinutes['distraction'] || 0) + (totalMinutes['rabbit-hole'] || 0);
                return {
                    averageScore: daysWithLogs > 0 ? totalScore / daysWithLogs : 0,
                    productiveTime,
                    distractionTime,
                    categoryTotals: totalMinutes
                };
            }
            function renderAnalyticsChart(categoryTotals) {
                const ctx = chartCanvas.getContext('2d');
                const labels = Object.values(CATEGORY_STYLES).map(s => s.label);
                const data = labels.map(label => {
                    const catKey = Object.keys(CATEGORY_STYLES).find(key => CATEGORY_STYLES[key].label === label);
                    return (categoryTotals[catKey] || 0) / 60;
                });
                const backgroundColors = Object.values(CATEGORY_STYLES).map(s => s.color);
                if (analyticsChart) analyticsChart.destroy();
                analyticsChart = new Chart(ctx, {
                    type: 'bar', data: { labels, datasets: [{ label: 'Hours Spent', data, backgroundColor: backgroundColors, borderWidth: 1 }] },
                    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#9ca3af' } }, y: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#d1d5db' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `Hours: ${c.raw.toFixed(2)}` } } } }
                });
            }

            // --- MODAL & IMPORT/EXPORT FUNCTIONS ---
            function openEditModal(id) {
                const allLogs = getCurrentProfileLogs();
                const entry = allLogs[currentDate]?.find(e => e.id === id);
                if (!entry) return;
                document.getElementById('edit-entry-id').value = entry.id;
                document.getElementById('edit-activity').value = entry.activity;
                document.getElementById('edit-start-time').value = entry.startTime;
                document.getElementById('edit-end-time').value = entry.endTime;
                document.getElementById('edit-category').value = entry.category;
                editModal.classList.remove('hidden');
            }
            function handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    let newEntries = [];
                    try {
                        if (file.name.endsWith('.csv')) newEntries = parseCSV(e.target.result);
                        else if (file.name.endsWith('.xlsx')) newEntries = parseXLSX(e.target.result);
                        else { alert('Unsupported file type.'); return; }
                    } catch (error) { alert(`Error parsing file: ${error.message}`); return; }
                    if (newEntries.length > 0) {
                        const merge = confirm('Import successful. MERGE with current day\'s log? (Cancel to REPLACE)');
                        const allLogs = getCurrentProfileLogs();
                        const currentLog = allLogs[currentDate] || [];
                        allLogs[currentDate] = merge ? [...currentLog, ...newEntries] : newEntries;
                        allLogs[currentDate].sort((a, b) => a.startTime.localeCompare(b.startTime));
                        saveAppData();
                        render();
                    }
                };
                if (file.name.endsWith('.csv')) reader.readAsText(file);
                else reader.readAsArrayBuffer(file);
                importFileInput.value = '';
            }
            function parseCSV(data) { return data.split('\n').slice(1).map(processRow).filter(Boolean); }
            function parseXLSX(data) {
                const workbook = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 }).slice(1);
                return json.map(processRow).filter(Boolean);
            }
            function processRow(row) {
                const columns = Array.isArray(row) ? row : row.split(',');
                if (columns.length < 5) return null;
                const [startTime, endTime, , activity, categoryLabel] = columns;
                const categoryKey = CATEGORY_REVERSE_MAP[categoryLabel.toLowerCase().trim()];
                if (!categoryKey) return null;
                return createEntryFromForm({ querySelector: (sel) => ({ '[id*="-activity"]': { value: activity }, '[id*="-start-time"]': { value: startTime }, '[id*="-end-time"]': { value: endTime }, '[id*="-category"]': { value: categoryKey } })[sel] });
            }
            function exportToCSV() {
                const currentLog = getCurrentProfileLogs()[currentDate] || [];
                if (currentLog.length === 0) return;
                const headers = ['Start Time', 'End Time', 'Duration (min)', 'Activity', 'Category', 'Points'];
                const rows = currentLog.map(entry => [ entry.startTime, entry.endTime, entry.duration.toFixed(0), `"${entry.activity.replace(/"/g, '""')}"`, CATEGORY_STYLES[entry.category].label, entry.points.toFixed(1) ]);
                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows.map(e => e.join(','))].join('\n');
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `productivity-log-${currentDate}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            function generateMarkdown() {
                const currentLog = getCurrentProfileLogs()[currentDate] || [];
                const totalScore = currentLog.reduce((sum, entry) => sum + entry.points, 0);
                let md = `## Productivity Report - ${currentDate}\n\n`;
                md += `**Total Score:** ${totalScore.toFixed(1)}\n\n`;
                md += `### Time Summary\n`;
                const summary = {};
                currentLog.forEach(entry => { summary[entry.category] = (summary[entry.category] || 0) + entry.duration; });
                Object.keys(summary).forEach(cat => { md += `- **${CATEGORY_STYLES[cat].label}:** ${formatDuration(summary[cat])}\n`; });
                md += `\n### Activity Log\n`;
                md += `| Time | Duration | Activity | Category | Points |\n`;
                md += `|:---|:---|:---|:---|---:|\n`;
                currentLog.forEach(entry => { md += `| ${entry.startTime} - ${entry.endTime} | ${formatDuration(entry.duration)} | ${entry.activity} | ${CATEGORY_STYLES[entry.category].label} | ${entry.points.toFixed(1)} |\n`; });
                return md;
            }
            function showMarkdownModal() {
                if ((getCurrentProfileLogs()[currentDate] || []).length === 0) return;
                markdownOutput.value = generateMarkdown();
                markdownModal.classList.remove('hidden');
            }
            function copyMarkdownToClipboard() {
                navigator.clipboard.writeText(markdownOutput.value).then(() => {
                    copyMdBtn.textContent = 'Copied!';
                    setTimeout(() => { copyMdBtn.textContent = 'Copy to Clipboard'; markdownModal.classList.add('hidden'); }, 1500);
                }).catch(err => alert('Failed to copy.'));
            }
            function exportAllData() {
                const dataStr = JSON.stringify(appData, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'productivity-tracker-backup.json');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            function importAllData(event) {
                const file = event.target.files[0];
                if (!file) return;
                if (confirm('Are you sure you want to import this backup? This will overwrite all current profiles and data.')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            // Basic validation
                            if (importedData.currentProfile && importedData.profiles) {
                                appData = importedData;
                                saveAppData();
                                currentDate = getTodayDateString(); // Reset to today on import
                                initialize();
                                alert('Backup imported successfully!');
                            } else {
                                alert('Invalid backup file format.');
                            }
                        } catch (error) {
                            alert('Failed to read or parse the backup file.');
                        }
                    };
                    reader.readAsText(file);
                }
                importAllInput.value = '';
            }

            // --- START THE APP ---
            initialize();
        });
    </script>
</body>
</html>
