<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Productivity Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Library for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Library for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root, html[data-theme='dark'] {
            --color-bg-primary: #111827;
            --color-bg-secondary: #1f2937;
            --color-bg-tertiary: #374151;
            --color-bg-inset: #111827;
            --color-text-primary: #d1d5db;
            --color-text-secondary: #9ca3af;
            --color-text-heading: #ffffff;
            --color-border-primary: #374151;
            --color-accent: #4f46e5;
            --color-accent-hover: #4338ca;
            --color-chart-grid: rgba(255, 255, 255, 0.1);
            --color-chart-ticks: #9ca3af;
            --color-category-deep-work: rgba(74, 222, 128, 0.7);
            --color-category-shallow-work: rgba(250, 204, 21, 0.7);
            --color-category-leisure: rgba(96, 165, 250, 0.7);
            --color-category-break: rgba(56, 189, 248, 0.7);
            --color-category-distraction: rgba(248, 113, 113, 0.7);
            --color-category-rabbit-hole: rgba(192, 132, 252, 0.7);
        }

        html[data-theme='light'] {
            --color-bg-primary: #f3f4f6;
            --color-bg-secondary: #ffffff;
            --color-bg-tertiary: #e5e7eb;
            --color-bg-inset: #f9fafb;
            --color-text-primary: #374151;
            --color-text-secondary: #6b7280;
            --color-text-heading: #111827;
            --color-border-primary: #d1d5db;
            --color-accent: #4f46e5;
            --color-accent-hover: #6366f1;
            --color-chart-grid: rgba(0, 0, 0, 0.1);
            --color-chart-ticks: #6b7280;
        }
        
        html[data-theme='rose'] {
            --color-bg-primary: #1c131a;
            --color-bg-secondary: #2b1c26;
            --color-bg-tertiary: #452c3d;
            --color-text-primary: #fbe7f5;
            --color-text-secondary: #e4badb;
            --color-text-heading: #fff1fb;
            --color-border-primary: #5e3a52;
            --color-accent: #e11d48;
            --color-accent-hover: #f43f5e;
        }

        html[data-theme='forest'] {
            --color-bg-primary: #0f1713;
            --color-bg-secondary: #1a2e25;
            --color-bg-tertiary: #2a4a3e;
            --color-text-primary: #d1fae5;
            --color-text-secondary: #a7f3d0;
            --color-text-heading: #ecfdf5;
            --color-border-primary: #3d6e5a;
            --color-accent: #22c55e;
            --color-accent-hover: #4ade80;
        }
        
        html[data-theme='ocean'] {
            --color-bg-primary: #f0f9ff;
            --color-bg-secondary: #ffffff;
            --color-bg-tertiary: #e0f2fe;
            --color-text-primary: #0c4a6e;
            --color-text-secondary: #0369a1;
            --color-text-heading: #082f49;
            --color-border-primary: #bae6fd;
            --color-accent: #0ea5e9;
            --color-accent-hover: #38bdf8;
        }

        html[data-theme='slate'] {
            --color-bg-primary: #f8fafc;
            --color-bg-secondary: #ffffff;
            --color-bg-tertiary: #f1f5f9;
            --color-text-primary: #334155;
            --color-text-secondary: #64748b;
            --color-text-heading: #0f172a;
            --color-border-primary: #e2e8f0;
            --color-accent: #475569;
            --color-accent-hover: #64748b;
        }


        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .bg-primary { background-color: var(--color-bg-primary); }
        .bg-secondary { background-color: var(--color-bg-secondary); }
        .bg-tertiary { background-color: var(--color-bg-tertiary); }
        .bg-inset { background-color: var(--color-bg-inset); }
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .text-heading { color: var(--color-text-heading); }
        .border-primary { border-color: var(--color-border-primary); }
        .divide-primary > :not([hidden]) ~ :not([hidden]) { border-color: var(--color-border-primary); }
        
        input, select {
            background-color: var(--color-bg-tertiary);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border-primary);
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: var(--color-bg-primary) === '#111827' ? 'invert(1)' : 'none';
        }

        /* Sidebar Styles */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }
        #sidebar.open {
            transform: translateX(0);
        }
        
        /* Modal transitions */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-backdrop:not(.hidden) .modal-content {
            opacity: 1;
            transform: scale(1);
        }

        /* Theme Preview Styles */
        .theme-preview {
            border: 2px solid transparent;
            transition: border-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .theme-preview:hover {
            transform: translateY(-4px);
        }
        .theme-preview.selected {
            border-color: var(--color-accent);
        }

    </style>
</head>
<body class="antialiased">

    <!-- Sidebar -->
    <aside id="sidebar" class="bg-secondary fixed top-0 left-0 z-40 w-64 h-screen p-4 overflow-y-auto shadow-xl">
        <h2 class="text-2xl font-bold text-heading mb-6">Tracker Menu</h2>
        
        <div class="space-y-6">
            <!-- Profile Section -->
            <div>
                <h3 class="text-xs font-semibold uppercase text-secondary mb-2">Profile</h3>
                <div class="space-y-2">
                    <select id="profile-selector" class="w-full p-2 rounded-md"></select>
                    <button id="add-profile-btn" class="w-full text-sm bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-md transition-colors">Add Profile</button>
                    <button id="edit-profile-btn" class="w-full text-sm bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-3 rounded-md transition-colors">Edit Profile</button>
                    <button id="delete-profile-btn" class="w-full text-sm bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-md transition-colors">Delete Profile</button>
                </div>
            </div>

            <!-- Data Management -->
            <div>
                <h3 class="text-xs font-semibold uppercase text-secondary mb-2">Data</h3>
                <div class="space-y-2">
                    <button id="import-all-btn" class="w-full text-sm bg-tertiary hover:bg-opacity-80 text-primary font-semibold py-2 px-3 rounded-md transition-colors">Import Backup</button>
                    <button id="export-all-btn" class="w-full text-sm bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-md transition-colors">Export All Data</button>
                    <input type="file" id="import-all-input" class="hidden" accept=".json">
                </div>
            </div>

            <!-- Settings -->
            <div>
                <h3 class="text-xs font-semibold uppercase text-secondary mb-2">Settings</h3>
                <button id="customize-theme-btn" class="w-full text-sm bg-tertiary hover:bg-opacity-80 text-primary font-semibold py-2 px-3 rounded-md transition-colors">Customize Theme</button>
            </div>
        </div>
    </aside>

    <!-- Hamburger Menu Button -->
    <button id="menu-toggle" class="fixed top-4 left-4 z-50 p-2 rounded-md bg-secondary shadow-lg">
        <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>

    <main id="main-content" class="transition-all duration-300">
        <div class="container mx-auto p-4 md:p-8 max-w-7xl">
            <!-- Header -->
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-heading">Productivity Tracker</h1>
                <p class="text-secondary mt-2">Log your activities, track your history, and visualize your progress.</p>
            </header>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">

                <!-- Left Column: Input & Summary -->
                <div class="lg:col-span-2 space-y-8">
                    
                    <!-- Input Form -->
                    <div class="bg-secondary p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4 text-heading">Log Activity</h2>
                        <form id="log-form" class="space-y-4">
                            <!-- Form fields... -->
                            <div>
                                <label for="activity" class="block text-sm font-medium text-secondary">Activity Description</label>
                                <input type="text" id="activity" name="activity" required class="mt-1 block w-full rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="start-time" class="block text-sm font-medium text-secondary">Start Time</label>
                                    <input type="time" id="start-time" name="start-time" required class="mt-1 block w-full rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2">
                                </div>
                                <div>
                                    <label for="end-time" class="block text-sm font-medium text-secondary">End Time</label>
                                    <input type="time" id="end-time" name="end-time" required class="mt-1 block w-full rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2">
                                </div>
                            </div>
                            <div>
                                <label for="category" class="block text-sm font-medium text-secondary">Category</label>
                                <select id="category" name="category" class="mt-1 block w-full rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2">
                                    <option value="deep-work">Deep Work (Study, etc.)</option>
                                    <option value="shallow-work">Shallow Work (Planning, Email)</option>
                                    <option value="leisure">Scheduled Leisure (Gaming, etc.)</option>
                                    <option value="break">Scheduled Break (Rest, Lunch)</option>
                                    <option value="distraction">Distraction (Unplanned browsing)</option>
                                    <option value="rabbit-hole">Distraction (Rabbit Hole)</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 shadow-md">Add to Log</button>
                        </form>
                    </div>

                    <!-- Summary Dashboard -->
                    <div class="bg-secondary p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4 text-heading">Daily Summary</h2>
                        <div class="space-y-4">
                            <div class="bg-tertiary p-4 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="font-bold text-lg text-primary">Productivity Score:</span>
                                    <span id="total-score" class="text-3xl font-bold text-indigo-400">0</span>
                                </div>
                            </div>
                            <div id="summary-details" class="space-y-2 text-sm">
                                <!-- Summary details will be injected here by JS -->
                            </div>
                            <div class="border-t border-primary pt-4 flex space-x-2">
                                <button id="export-csv" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-md text-sm transition duration-300">Export Day (CSV)</button>
                                <button id="export-md" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-md text-sm transition duration-300">Copy Day (MD)</button>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Quests Card -->
                    <div id="daily-quests-card" class="bg-secondary p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4 text-heading">Daily Quests</h2>
                        <div id="quests-list" class="space-y-3">
                            <!-- Quests will be rendered here by JS -->
                        </div>
                    </div>
                </div>

                <!-- Right Column: Activity Log -->
                <div class="lg:col-span-3 bg-secondary p-6 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <div class="flex items-center gap-4">
                            <h2 id="log-title" class="text-2xl font-semibold text-heading">Log for Today</h2>
                            <input type="date" id="date-picker">
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="import-btn" class="text-sm bg-tertiary hover:bg-opacity-80 text-primary font-semibold py-1 px-3 rounded-md transition-colors">Import Day...</button>
                            <button id="clear-log" class="text-sm text-red-400 hover:text-red-500 transition-colors font-semibold">Clear Day</button>
                            <input type="file" id="import-file-input" class="hidden" accept=".csv, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-primary">
                            <thead class="bg-tertiary/50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Time</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Duration</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Activity</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Category</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-secondary uppercase tracking-wider">Points</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-secondary uppercase tracking-wider"></th>
                                </tr>
                            </thead>
                            <tbody id="log-table-body" class="divide-y divide-primary">
                                 <tr id="empty-row">
                                    <td colspan="6" class="text-center py-10 text-secondary">Your logged activities will appear here.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Dashboard -->
            <div id="analytics-dashboard" class="mt-8 bg-secondary p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <h2 class="text-2xl font-semibold text-heading">Analytics Dashboard</h2>
                    <div class="flex rounded-lg bg-tertiary p-1">
                        <button id="weekly-btn" class="dashboard-toggle-btn px-4 py-1 text-sm font-semibold rounded-md transition-colors text-primary">This Week</button>
                        <button id="monthly-btn" class="dashboard-toggle-btn px-4 py-1 text-sm font-semibold rounded-md transition-colors text-primary">This Month</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                    <div class="bg-tertiary p-4 rounded-lg">
                        <div class="text-sm text-secondary">Avg. Daily Score</div>
                        <div id="avg-score" class="text-2xl font-bold text-indigo-400">0.0</div>
                    </div>
                    <div class="bg-tertiary p-4 rounded-lg">
                        <div class="text-sm text-secondary">Total Productive Time</div>
                        <div id="total-productive-time" class="text-2xl font-bold text-green-400">0h 0m</div>
                    </div>
                    <div class="bg-tertiary p-4 rounded-lg">
                        <div class="text-sm text-secondary">Total Distraction Time</div>
                        <div id="total-distraction-time" class="text-2xl font-bold text-red-400">0h 0m</div>
                    </div>
                </div>
                <div>
                    <canvas id="analytics-chart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="theme-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="modal-content bg-secondary rounded-lg shadow-xl p-6 w-full max-w-2xl space-y-4">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-heading">Customize Theme</h3>
                <button id="close-theme-modal-btn" class="text-secondary hover:text-primary">&times;</button>
            </div>
            <div id="theme-previews" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <!-- Theme previews will be rendered here by JS -->
            </div>
        </div>
    </div>
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="modal-content bg-secondary rounded-lg shadow-xl p-6 w-full max-w-lg space-y-4">
             <h3 class="text-xl font-semibold text-heading">Edit Log Entry</h3>
            <form id="edit-form" class="space-y-4">
                <!-- Form content is dynamically generated by JS -->
            </form>
        </div>
    </div>
    <div id="markdown-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="modal-content bg-secondary rounded-lg shadow-xl p-6 w-full max-w-2xl space-y-4">
            <h3 class="text-xl font-semibold text-heading">Export as Markdown</h3>
            <textarea id="markdown-output" readonly class="w-full h-64 bg-primary text-primary font-mono text-sm p-3 rounded-md border border-primary focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            <div class="flex justify-end space-x-3">
                <button id="copy-md-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition">Copy to Clipboard</button>
                <button id="close-modal-btn" class="bg-tertiary hover:bg-opacity-80 text-primary font-bold py-2 px-4 rounded-md transition">Close</button>
            </div>
        </div>
    </div>
    <div id="edit-profile-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="modal-content bg-secondary rounded-lg shadow-xl p-6 w-full max-w-lg space-y-4">
            <h3 class="text-xl font-semibold text-heading">Edit Profile</h3>
            <form id="edit-profile-form" class="space-y-4">
                <div>
                    <label for="edit-profile-name" class="block text-sm font-medium text-secondary">Profile Name</label>
                    <input type="text" id="edit-profile-name" required class="mt-1 block w-full rounded-md shadow-sm p-2">
                </div>
                <div>
                    <label for="edit-profile-bio" class="block text-sm font-medium text-secondary">Bio</label>
                    <textarea id="edit-profile-bio" rows="3" class="mt-1 block w-full rounded-md shadow-sm p-2"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancel-edit-profile-btn" class="bg-tertiary hover:bg-opacity-80 text-primary font-bold py-2 px-4 rounded-md transition">Cancel</button>
                    <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition">Save Profile</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL STATE & CONFIG ---
            let appData = {};
            let currentDate = getTodayDateString();
            let analyticsChart = null;
            let currentDashboardView = 'weekly';

            const THEME_CONFIG = {
                'dark': { name: 'Dark', colors: { bgPrimary: '#111827', bgSecondary: '#1f2937', bgTertiary: '#374151', accent: '#4f46e5' } },
                'light': { name: 'Light', colors: { bgPrimary: '#f3f4f6', bgSecondary: '#ffffff', bgTertiary: '#e5e7eb', accent: '#4f46e5' } },
                'rose': { name: 'Rosé', colors: { bgPrimary: '#1c131a', bgSecondary: '#2b1c26', bgTertiary: '#452c3d', accent: '#e11d48' } },
                'forest': { name: 'Forest', colors: { bgPrimary: '#0f1713', bgSecondary: '#1a2e25', bgTertiary: '#2a4a3e', accent: '#22c55e' } },
                'ocean': { name: 'Ocean', colors: { bgPrimary: '#f0f9ff', bgSecondary: '#ffffff', bgTertiary: '#e0f2fe', accent: '#0ea5e9' } },
                'slate': { name: 'Slate', colors: { bgPrimary: '#f8fafc', bgSecondary: '#ffffff', bgTertiary: '#f1f5f9', accent: '#475569' } },
            };

            const QUESTS = {
                'first_step': { title: 'First Step', description: 'Log your first activity of the day.' },
                'focused_sprint': { title: 'Focused Sprint', description: 'Complete a 30-minute deep work session.' },
                'point_collector': { title: 'Point Collector', description: 'Earn a total of 50 points.' },
                'power_hour': { title: 'Power Hour', description: 'Log 60+ minutes of Deep Work.' },
                'the_90_minute_cycle': { title: 'The 90-Minute Cycle', description: 'Log a continuous 90-minute Deep Work session.' },
                'balanced_effort': { title: 'Balanced Effort', description: 'Log 60+ mins Deep & 60+ mins Shallow Work.' },
                'deep_work_marathon': { title: 'Deep Work Marathon', description: 'Log 3+ hours of Deep Work.' },
                'elite_performer': { title: 'Elite Performer', description: 'Earn a total of 300 points.' },
                'perfect_focus': { title: 'Perfect Focus', description: 'Complete the day with 0 distraction time.' },
            };

            const CATEGORY_STYLES = {
                'deep-work': { label: 'Deep Work', color: 'var(--color-category-deep-work)', pointsPerMin: 10 / 30 },
                'shallow-work': { label: 'Shallow Work', color: 'var(--color-category-shallow-work)', pointsPerMin: 4 / 30 },
                'leisure': { label: 'Leisure', color: 'var(--color-category-leisure)', pointsPerMin: 2 / 30 },
                'break': { label: 'Break', color: 'var(--color-category-break)', pointsPerMin: 2 / 30 },
                'distraction': { label: 'Distraction', color: 'var(--color-category-distraction)', pointsPerMin: -5 / 30 },
                'rabbit-hole': { label: 'Rabbit Hole', color: 'var(--color-category-rabbit-hole)', pointsPerMin: -10 / 30 }
            };
            const CATEGORY_REVERSE_MAP = Object.entries(CATEGORY_STYLES).reduce((acc, [key, value]) => {
                acc[value.label.toLowerCase()] = key;
                return acc;
            }, {});
            const STORAGE_KEY = 'productivityTrackerProfiles_v5'; 

            // --- DOM ELEMENT SELECTORS ---
            const form = document.getElementById('log-form');
            const logTableBody = document.getElementById('log-table-body');
            const totalScoreEl = document.getElementById('total-score');
            const summaryDetailsEl = document.getElementById('summary-details');
            const emptyRow = document.getElementById('empty-row');
            const exportCsvBtn = document.getElementById('export-csv');
            const exportMdBtn = document.getElementById('export-md');
            const clearLogBtn = document.getElementById('clear-log');
            const importBtn = document.getElementById('import-btn');
            const importFileInput = document.getElementById('import-file-input');
            const datePicker = document.getElementById('date-picker');
            const logTitle = document.getElementById('log-title');
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const markdownModal = document.getElementById('markdown-modal');
            const markdownOutput = document.getElementById('markdown-output');
            const copyMdBtn = document.getElementById('copy-md-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const weeklyBtn = document.getElementById('weekly-btn');
            const monthlyBtn = document.getElementById('monthly-btn');
            const avgScoreEl = document.getElementById('avg-score');
            const totalProductiveTimeEl = document.getElementById('total-productive-time');
            const totalDistractionTimeEl = document.getElementById('total-distraction-time');
            const chartCanvas = document.getElementById('analytics-chart');
            const profileSelector = document.getElementById('profile-selector');
            const addProfileBtn = document.getElementById('add-profile-btn');
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const deleteProfileBtn = document.getElementById('delete-profile-btn');
            const importAllBtn = document.getElementById('import-all-btn');
            const exportAllBtn = document.getElementById('export-all-btn');
            const importAllInput = document.getElementById('import-all-input');
            const editProfileModal = document.getElementById('edit-profile-modal');
            const editProfileForm = document.getElementById('edit-profile-form');
            const cancelEditProfileBtn = document.getElementById('cancel-edit-profile-btn');
            const questsListEl = document.getElementById('quests-list');
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            const mainContent = document.getElementById('main-content');
            const customizeThemeBtn = document.getElementById('customize-theme-btn');
            const themeModal = document.getElementById('theme-modal');
            const closeThemeModalBtn = document.getElementById('close-theme-modal-btn');
            const themePreviewsContainer = document.getElementById('theme-previews');

            // --- INITIALIZATION ---
            function initialize() {
                loadAppData();
                loadTheme();
                datePicker.value = currentDate;
                render();
                addEventListeners();
            }

            function addEventListeners() {
                form.addEventListener('submit', e => { e.preventDefault(); addActivity(); });
                logTableBody.addEventListener('click', handleLogTableClick);
                editForm.addEventListener('submit', e => { e.preventDefault(); saveEdit(); });
                clearLogBtn.addEventListener('click', clearCurrentLog);
                datePicker.addEventListener('change', handleDateChange);
                importBtn.addEventListener('click', () => importFileInput.click());
                importFileInput.addEventListener('change', handleFileImport);
                exportCsvBtn.addEventListener('click', exportToCSV);
                exportMdBtn.addEventListener('click', showMarkdownModal);
                closeModalBtn.addEventListener('click', () => markdownModal.classList.add('hidden'));
                copyMdBtn.addEventListener('click', copyMarkdownToClipboard);
                weeklyBtn.addEventListener('click', () => setDashboardView('weekly'));
                monthlyBtn.addEventListener('click', () => setDashboardView('monthly'));
                profileSelector.addEventListener('change', switchProfile);
                addProfileBtn.addEventListener('click', addNewProfile);
                editProfileBtn.addEventListener('click', openEditProfileModal);
                deleteProfileBtn.addEventListener('click', deleteCurrentProfile);
                importAllBtn.addEventListener('click', () => importAllInput.click());
                importAllInput.addEventListener('change', importAllData);
                exportAllBtn.addEventListener('click', exportAllData);
                editProfileForm.addEventListener('submit', e => { e.preventDefault(); saveProfileEdit(); });
                cancelEditProfileBtn.addEventListener('click', () => editProfileModal.classList.add('hidden'));
                menuToggle.addEventListener('click', toggleSidebar);
                customizeThemeBtn.addEventListener('click', openThemeModal);
                closeThemeModalBtn.addEventListener('click', () => themeModal.classList.add('hidden'));
                themePreviewsContainer.addEventListener('click', handleThemeSelection);
            }

            // --- THEME & SIDEBAR ---
            function toggleSidebar() {
                sidebar.classList.toggle('open');
                mainContent.classList.toggle('lg:ml-64');
            }
            function loadTheme() {
                const savedTheme = localStorage.getItem('theme') || 'dark';
                setTheme(savedTheme);
            }
            function setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                if(analyticsChart) {
                    renderDashboard();
                }
            }
            function openThemeModal() {
                renderThemePreviews();
                themeModal.classList.remove('hidden');
            }
            function handleThemeSelection(e) {
                const themeButton = e.target.closest('.theme-preview');
                if (themeButton) {
                    const themeName = themeButton.dataset.theme;
                    setTheme(themeName);
                    renderThemePreviews(); // Re-render to show selection
                }
            }

            // --- DATA & PROFILE MANAGEMENT ---
            function saveAppData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }
            function loadAppData() {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    appData = JSON.parse(savedData);
                } else {
                    appData = {
                        currentProfile: 'Default',
                        profiles: {
                            'Default': { name: 'Default', bio: '', logs: {}, quests: {} }
                        }
                    };
                    saveAppData();
                }
            }
            function getCurrentProfile() { return appData.profiles[appData.currentProfile]; }
            function switchProfile() { appData.currentProfile = profileSelector.value; saveAppData(); render(); }
            function addNewProfile() {
                const profileName = prompt('Enter a name for the new profile:');
                if (profileName && !appData.profiles[profileName]) {
                    appData.profiles[profileName] = { name: profileName, bio: '', logs: {}, quests: {} };
                    appData.currentProfile = profileName;
                    saveAppData();
                    render();
                } else if (profileName) {
                    alert('A profile with this name already exists.');
                }
            }
            function deleteCurrentProfile() {
                const profileToDelete = appData.currentProfile;
                if (Object.keys(appData.profiles).length <= 1) {
                    alert('Cannot delete the last profile.');
                    return;
                }
                if (confirm(`Are you sure you want to delete the "${profileToDelete}" profile and all its data? This cannot be undone.`)) {
                    delete appData.profiles[profileToDelete];
                    appData.currentProfile = Object.keys(appData.profiles)[0];
                    saveAppData();
                    render();
                }
            }
            function openEditProfileModal() {
                const profile = getCurrentProfile();
                document.getElementById('edit-profile-name').value = profile.name;
                document.getElementById('edit-profile-bio').value = profile.bio || '';
                editProfileModal.classList.remove('hidden');
            }
            function saveProfileEdit() {
                const oldName = appData.currentProfile;
                const newName = document.getElementById('edit-profile-name').value.trim();
                const newBio = document.getElementById('edit-profile-bio').value.trim();

                if (!newName) {
                    alert('Profile name cannot be empty.');
                    return;
                }

                if (newName !== oldName && appData.profiles[newName]) {
                    alert('A profile with this name already exists.');
                    return;
                }

                const profileData = appData.profiles[oldName];
                profileData.name = newName;
                profileData.bio = newBio;

                if (newName !== oldName) {
                    appData.profiles[newName] = profileData;
                    delete appData.profiles[oldName];
                    appData.currentProfile = newName;
                }
                
                saveAppData();
                render();
                editProfileModal.classList.add('hidden');
            }

            // --- DATE & TIME UTILITIES ---
            function getTodayDateString() {
                const today = new Date();
                return new Date(today.getTime() - (today.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            }
            function formatDuration(minutes, showZero = false) {
                if (minutes === 0 && !showZero) return '0m';
                const h = Math.floor(minutes / 60);
                const m = Math.floor(minutes % 60);
                let result = '';
                if (h > 0) result += `${h}h `;
                if (m > 0 || h === 0) result += `${m}m`;
                return result.trim();
            }

            // --- EVENT HANDLERS ---
            function handleLogTableClick(e) {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if (editBtn) openEditModal(Number(editBtn.dataset.id));
                else if (deleteBtn) deleteActivity(Number(deleteBtn.dataset.id));
            }
            function handleDateChange() { currentDate = datePicker.value; render(); }
            function setDashboardView(view) { currentDashboardView = view; render(); }

            // --- CORE LOGIC (ADD, EDIT, DELETE) ---
            function addActivity() {
                const newEntry = createEntryFromForm(form);
                if (!newEntry) return;
                const profile = getCurrentProfile();
                if (!profile.logs[currentDate]) profile.logs[currentDate] = [];
                profile.logs[currentDate].push(newEntry);
                profile.logs[currentDate].sort((a, b) => a.startTime.localeCompare(b.startTime));
                saveAppData();
                render();
                form.reset();
                form.activity.focus();
            }
            function saveEdit() {
                const profileLogs = getCurrentProfile().logs;
                const id = Number(editForm.querySelector('#edit-entry-id').value);
                const entryIndex = profileLogs[currentDate]?.findIndex(e => e.id === id);
                if (entryIndex === -1) return;
                const updatedEntry = createEntryFromForm(editForm, id);
                if (!updatedEntry) return;
                profileLogs[currentDate][entryIndex] = updatedEntry;
                profileLogs[currentDate].sort((a, b) => a.startTime.localeCompare(b.startTime));
                saveAppData();
                render();
                editModal.classList.add('hidden');
            }
            function deleteActivity(id) {
                const profileLogs = getCurrentProfile().logs;
                if (!profileLogs[currentDate]) return;
                profileLogs[currentDate] = profileLogs[currentDate].filter(entry => entry.id !== id);
                if (profileLogs[currentDate].length === 0) delete profileLogs[currentDate];
                saveAppData();
                render();
            }
            function clearCurrentLog() {
                if (confirm(`Are you sure you want to clear all entries for ${currentDate}?`)) {
                    const profileLogs = getCurrentProfile().logs;
                    delete profileLogs[currentDate];
                    saveAppData();
                    render();
                }
            }
            
            function createEntryFromForm(formElement, id = null) {
                let activity, startTime, endTime, category;
                if (formElement.id === 'edit-form') {
                    activity = formElement.querySelector('#edit-activity').value;
                    startTime = formElement.querySelector('#edit-start-time').value;
                    endTime = formElement.querySelector('#edit-end-time').value;
                    category = formElement.querySelector('#edit-category').value;
                } else { // Assumes log-form
                    activity = formElement.querySelector('#activity').value;
                    startTime = formElement.querySelector('#start-time').value;
                    endTime = formElement.querySelector('#end-time').value;
                    category = formElement.querySelector('#category').value;
                }
                
                if (!activity || !startTime || !endTime || !category) return null;
                
                const start = new Date(`1970-01-01T${startTime}`);
                const end = new Date(`1970-01-01T${endTime}`);
                if (end <= start) {
                    alert("End time must be after start time.");
                    return null;
                }
                
                const duration = (end - start) / (1000 * 60);
                const points = duration * CATEGORY_STYLES[category].pointsPerMin;
                return { id: id || Date.now(), activity, startTime, endTime, duration, category, points };
            }

            // --- RENDER FUNCTIONS ---
            function render() {
                const profile = getCurrentProfile();
                if (!profile) {
                    appData.currentProfile = Object.keys(appData.profiles)[0];
                    render();
                    return;
                }
                const currentLog = profile.logs[currentDate] || [];
                
                initializeAndEvaluateQuests(profile, currentDate, currentLog);

                renderProfileSelector();
                updateLogTitle();
                renderLogTable(currentLog);
                renderDailySummary(currentLog);
                renderQuests(profile, currentDate);
                renderDashboard();
            }
            function renderProfileSelector() {
                profileSelector.innerHTML = '';
                Object.keys(appData.profiles).forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    if (name === appData.currentProfile) option.selected = true;
                    profileSelector.appendChild(option);
                });
            }
            function updateLogTitle() {
                logTitle.textContent = currentDate === getTodayDateString() ? "Log for Today" : `Log for ${currentDate}`;
            }
            function renderLogTable(log) {
                logTableBody.innerHTML = '';
                if (log.length === 0) { logTableBody.appendChild(emptyRow); return; }
                log.forEach(entry => {
                    const tr = document.createElement('tr');
                    tr.classList.add('hover:bg-tertiary/50', 'transition-colors');
                    const categoryStyle = CATEGORY_STYLES[entry.category];
                    tr.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${entry.startTime} - ${entry.endTime}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">${formatDuration(entry.duration)}</td>
                        <td class="px-4 py-3 whitespace-nowrap font-medium">${entry.activity}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full text-white" style="background-color:${categoryStyle.color};">${categoryStyle.label}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-bold ${entry.points > 0 ? 'text-green-400' : 'text-red-400'}">${entry.points.toFixed(1)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button data-id="${entry.id}" class="edit-btn text-secondary hover:text-indigo-400 transition-colors" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" /></svg></button>
                            <button data-id="${entry.id}" class="delete-btn text-secondary hover:text-red-500 transition-colors" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </td>
                    `;
                    logTableBody.appendChild(tr);
                });
            }
            function renderDailySummary(log) {
                totalScoreEl.textContent = log.reduce((sum, entry) => sum + entry.points, 0).toFixed(1);
                const summary = {};
                log.forEach(entry => { summary[entry.category] = (summary[entry.category] || 0) + entry.duration; });
                summaryDetailsEl.innerHTML = Object.values(CATEGORY_STYLES).map(catStyle => {
                    const time = summary[Object.keys(CATEGORY_STYLES).find(key => CATEGORY_STYLES[key].label === catStyle.label)] || 0;
                    if (time === 0) return '';
                    return `<div class="flex justify-between items-center">
                        <div class="flex items-center"><span class="h-3 w-3 rounded-full mr-2" style="background-color:${catStyle.color};"></span><span>${catStyle.label}</span></div>
                        <span class="font-semibold">${formatDuration(time)}</span>
                    </div>`;
                }).join('');
            }

            // --- QUEST LOGIC ---
            function initializeAndEvaluateQuests(profile, date, log) {
                if (!profile.quests) profile.quests = {};
                if (!profile.quests[date]) {
                    profile.quests[date] = {};
                    Object.keys(QUESTS).forEach(key => profile.quests[date][key] = false);
                }
                evaluateQuests(profile, date, log);
            }

            function evaluateQuests(profile, date, log) {
                const dailyQuests = profile.quests[date];
                if (!log || log.length === 0) {
                    // Reset if no logs
                    Object.keys(QUESTS).forEach(key => dailyQuests[key] = false);
                    return;
                };

                // Calculate metrics
                const totalPoints = log.reduce((sum, entry) => sum + entry.points, 0);
                const timeByCategory = log.reduce((acc, entry) => {
                    acc[entry.category] = (acc[entry.category] || 0) + entry.duration;
                    return acc;
                }, {});
                const deepWorkTime = timeByCategory['deep-work'] || 0;
                const shallowWorkTime = timeByCategory['shallow-work'] || 0;
                const distractionTime = (timeByCategory['distraction'] || 0) + (timeByCategory['rabbit-hole'] || 0);
                const has30MinDeepWork = log.some(e => e.category === 'deep-work' && e.duration >= 30);
                const has90MinDeepWork = log.some(e => e.category === 'deep-work' && e.duration >= 90);

                // Tier 1
                dailyQuests.first_step = log.length > 0;
                dailyQuests.focused_sprint = has30MinDeepWork;
                dailyQuests.point_collector = totalPoints >= 50;
                
                // Tier 2
                dailyQuests.power_hour = deepWorkTime >= 60;
                dailyQuests.the_90_minute_cycle = has90MinDeepWork;
                dailyQuests.balanced_effort = deepWorkTime >= 60 && shallowWorkTime >= 60;

                // Tier 3
                dailyQuests.deep_work_marathon = deepWorkTime >= 180;
                dailyQuests.elite_performer = totalPoints >= 300;
                dailyQuests.perfect_focus = distractionTime === 0;
            }

            function renderQuests(profile, date) {
                const dailyQuests = profile.quests[date];
                if (!dailyQuests || Object.keys(dailyQuests).length === 0) {
                    questsListEl.innerHTML = '<p class="text-secondary">Log an activity to start your quests!</p>';
                    return;
                }

                questsListEl.innerHTML = Object.keys(QUESTS).map(key => {
                    const quest = QUESTS[key];
                    const isCompleted = dailyQuests[key];
                    return `
                        <div class="quest-item flex items-start gap-3 ${isCompleted ? 'completed' : ''}">
                            <div class="quest-icon mt-1">
                                ${isCompleted 
                                    ? '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>' 
                                    : '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'}
                            </div>
                            <div>
                                <h4 class="font-semibold text-primary">${quest.title}</h4>
                                <p class="text-xs text-secondary">${quest.description}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // --- ANALYTICS DASHBOARD LOGIC ---
            function renderDashboard() {
                weeklyBtn.classList.toggle('active', currentDashboardView === 'weekly');
                monthlyBtn.classList.toggle('active', currentDashboardView === 'monthly');
                const { startDate, endDate } = getDashboardDateRange();
                const stats = aggregateStatsForPeriod(startDate, endDate);
                avgScoreEl.textContent = stats.averageScore.toFixed(1);
                totalProductiveTimeEl.textContent = formatDuration(stats.productiveTime, true);
                totalDistractionTimeEl.textContent = formatDuration(stats.distractionTime, true);
                renderAnalyticsChart(stats.categoryTotals);
            }
            function getDashboardDateRange() {
                const today = new Date(currentDate + 'T00:00:00');
                let startDate, endDate;
                if (currentDashboardView === 'weekly') {
                    const dayOfWeek = today.getDay();
                    const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(today.setDate(diff));
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                } else {
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                }
                return { startDate, endDate };
            }
            function aggregateStatsForPeriod(startDate, endDate) {
                let totalMinutes = {};
                let totalScore = 0;
                let daysWithLogs = 0;
                const allLogs = getCurrentProfile().logs;
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    const dayLog = allLogs[dateStr];
                    if (dayLog && dayLog.length > 0) {
                        daysWithLogs++;
                        totalScore += dayLog.reduce((sum, e) => sum + e.points, 0);
                        dayLog.forEach(entry => {
                            totalMinutes[entry.category] = (totalMinutes[entry.category] || 0) + entry.duration;
                        });
                    }
                }
                const productiveTime = (totalMinutes['deep-work'] || 0) + (totalMinutes['shallow-work'] || 0);
                const distractionTime = (totalMinutes['distraction'] || 0) + (totalMinutes['rabbit-hole'] || 0);
                return {
                    averageScore: daysWithLogs > 0 ? totalScore / daysWithLogs : 0,
                    productiveTime,
                    distractionTime,
                    categoryTotals: totalMinutes
                };
            }
            function renderAnalyticsChart(categoryTotals) {
                const computedStyles = getComputedStyle(document.documentElement);
                const gridColor = computedStyles.getPropertyValue('--color-chart-grid').trim();
                const tickColor = computedStyles.getPropertyValue('--color-chart-ticks').trim();

                const ctx = chartCanvas.getContext('2d');
                const labels = Object.values(CATEGORY_STYLES).map(s => s.label);
                const data = labels.map(label => {
                    const catKey = Object.keys(CATEGORY_STYLES).find(key => CATEGORY_STYLES[key].label === label);
                    return (categoryTotals[catKey] || 0) / 60;
                });
                const backgroundColors = Object.values(CATEGORY_STYLES).map(s => computedStyles.getPropertyValue(s.color.slice(4, -1)).trim());
                
                if (analyticsChart) analyticsChart.destroy();
                
                analyticsChart = new Chart(ctx, {
                    type: 'bar', data: { labels, datasets: [{ label: 'Hours Spent', data, backgroundColor: backgroundColors, borderWidth: 1 }] },
                    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: tickColor } }, y: { grid: { color: gridColor }, ticks: { color: tickColor } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `Hours: ${c.raw.toFixed(2)}` } } } }
                });
            }

            // --- MODAL & IMPORT/EXPORT FUNCTIONS ---
            function openEditModal(id) {
                const profileLogs = getCurrentProfile().logs;
                const entry = profileLogs[currentDate]?.find(e => e.id === id);
                if (!entry) return;
                // Dynamically create form content to avoid duplication
                editForm.innerHTML = `
                    <input type="hidden" id="edit-entry-id" value="${entry.id}">
                    <div><label for="edit-activity" class="block text-sm font-medium text-secondary">Activity Description</label><input type="text" id="edit-activity" required class="mt-1 block w-full rounded-md shadow-sm p-2" value="${entry.activity.replace(/"/g, '&quot;')}"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="edit-start-time" class="block text-sm font-medium text-secondary">Start Time</label><input type="time" id="edit-start-time" required class="mt-1 block w-full rounded-md shadow-sm p-2" value="${entry.startTime}"></div>
                        <div><label for="edit-end-time" class="block text-sm font-medium text-secondary">End Time</label><input type="time" id="edit-end-time" required class="mt-1 block w-full rounded-md shadow-sm p-2" value="${entry.endTime}"></div>
                    </div>
                    <div><label for="edit-category" class="block text-sm font-medium text-secondary">Category</label><select id="edit-category" class="mt-1 block w-full rounded-md shadow-sm p-2"></select></div>
                    <div class="flex justify-end space-x-3 pt-2"><button type="button" id="cancel-edit-btn-inner" class="bg-tertiary hover:bg-opacity-80 text-primary font-bold py-2 px-4 rounded-md transition">Cancel</button><button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition">Save Changes</button></div>
                `;
                const categorySelect = editForm.querySelector('#edit-category');
                Object.keys(CATEGORY_STYLES).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = CATEGORY_STYLES[key].label;
                    if (key === entry.category) option.selected = true;
                    categorySelect.appendChild(option);
                });
                editForm.querySelector('#cancel-edit-btn-inner').addEventListener('click', () => editModal.classList.add('hidden'));
                editModal.classList.remove('hidden');
            }
            function handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    let newEntries = [];
                    try {
                        if (file.name.endsWith('.csv')) newEntries = parseCSV(e.target.result);
                        else if (file.name.endsWith('.xlsx')) newEntries = parseXLSX(e.target.result);
                        else { alert('Unsupported file type.'); return; }
                    } catch (error) { alert(`Error parsing file: ${error.message}`); return; }
                    if (newEntries.length > 0) {
                        const merge = confirm('Import successful. MERGE with current day\'s log? (Cancel to REPLACE)');
                        const profileLogs = getCurrentProfile().logs;
                        const currentLog = profileLogs[currentDate] || [];
                        profileLogs[currentDate] = merge ? [...currentLog, ...newEntries] : newEntries;
                        profileLogs[currentDate].sort((a, b) => a.startTime.localeCompare(b.startTime));
                        saveAppData();
                        render();
                    }
                };
                if (file.name.endsWith('.csv')) reader.readAsText(file);
                else reader.readAsArrayBuffer(file);
                importFileInput.value = '';
            }
            function parseCSV(data) { return data.split('\n').slice(1).map(processRow).filter(Boolean); }
            function parseXLSX(data) {
                const workbook = XLSX.read(data, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 }).slice(1);
                return json.map(processRow).filter(Boolean);
            }
            function processRow(row) {
                const columns = Array.isArray(row) ? row : row.split(',');
                if (columns.length < 5) return null;
                const [startTime, endTime, , activity, categoryLabel] = columns;
                const categoryKey = CATEGORY_REVERSE_MAP[categoryLabel.toLowerCase().trim()];
                if (!categoryKey) return null;
                return createEntryFromForm({ querySelector: (sel) => ({ '[id*="-activity"]': { value: activity }, '[id*="-start-time"]': { value: startTime }, '[id*="-end-time"]': { value: endTime }, '[id*="-category"]': { value: categoryKey } })[sel] });
            }
            function exportToCSV() {
                const currentLog = getCurrentProfile().logs[currentDate] || [];
                if (currentLog.length === 0) return;
                const headers = ['Start Time', 'End Time', 'Duration (min)', 'Activity', 'Category', 'Points'];
                const rows = currentLog.map(entry => [ entry.startTime, entry.endTime, entry.duration.toFixed(0), `"${entry.activity.replace(/"/g, '""')}"`, CATEGORY_STYLES[entry.category].label, entry.points.toFixed(1) ]);
                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows.map(e => e.join(','))].join('\n');
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `productivity-log-${currentDate}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            function generateMarkdown() {
                const currentLog = getCurrentProfile().logs[currentDate] || [];
                const totalScore = currentLog.reduce((sum, entry) => sum + entry.points, 0);
                let md = `## Productivity Report - ${currentDate}\n\n`;
                md += `**Total Score:** ${totalScore.toFixed(1)}\n\n`;
                md += `### Time Summary\n`;
                const summary = {};
                currentLog.forEach(entry => { summary[entry.category] = (summary[entry.category] || 0) + entry.duration; });
                Object.keys(summary).forEach(cat => { md += `- **${CATEGORY_STYLES[cat].label}:** ${formatDuration(summary[cat])}\n`; });
                md += `\n### Activity Log\n`;
                md += `| Time | Duration | Activity | Category | Points |\n`;
                md += `|:---|:---|:---|:---|---:|\n`;
                currentLog.forEach(entry => { md += `| ${entry.startTime} - ${entry.endTime} | ${formatDuration(entry.duration)} | ${entry.activity} | ${CATEGORY_STYLES[entry.category].label} | ${entry.points.toFixed(1)} |\n`; });
                return md;
            }
            function showMarkdownModal() {
                if ((getCurrentProfile().logs[currentDate] || []).length === 0) return;
                markdownOutput.value = generateMarkdown();
                markdownModal.classList.remove('hidden');
            }
            function copyMarkdownToClipboard() {
                navigator.clipboard.writeText(markdownOutput.value).then(() => {
                    copyMdBtn.textContent = 'Copied!';
                    setTimeout(() => { copyMdBtn.textContent = 'Copy to Clipboard'; markdownModal.classList.add('hidden'); }, 1500);
                }).catch(err => alert('Failed to copy.'));
            }
            function exportAllData() {
                const dataStr = JSON.stringify(appData, null, 2);
                const dataBlob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'productivity-tracker-backup.json');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            function importAllData(event) {
                const file = event.target.files[0];
                if (!file) return;
                if (confirm('Are you sure you want to import this backup? This will overwrite all current profiles and data.')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (importedData.currentProfile && importedData.profiles) {
                                appData = importedData;
                                saveAppData();
                                currentDate = getTodayDateString();
                                initialize();
                                alert('Backup imported successfully!');
                            } else {
                                alert('Invalid backup file format.');
                            }
                        } catch (error) {
                            alert('Failed to read or parse the backup file.');
                        }
                    };
                    reader.readAsText(file);
                }
                importAllInput.value = '';
            }
            function renderThemePreviews() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                themePreviewsContainer.innerHTML = Object.entries(THEME_CONFIG).map(([id, theme]) => {
                    const isSelected = currentTheme === id;
                    const colors = theme.colors;
                    return `
                        <button 
                            class="theme-preview rounded-lg p-3 text-left cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-secondary focus:ring-accent ${isSelected ? 'selected' : ''}"
                            data-theme="${id}" 
                            aria-pressed="${isSelected}"
                            aria-label="Select ${theme.name} theme"
                        >
                            <div class="w-full h-20 rounded-md p-2 flex flex-col gap-1" style="background-color: ${colors.bgPrimary};">
                                <div class="h-3 rounded-sm" style="background-color: ${colors.accent};"></div>
                                <div class="flex-grow flex gap-1">
                                    <div class="w-1/3 h-full rounded-sm" style="background-color: ${colors.bgSecondary};"></div>
                                    <div class="w-2/3 h-full rounded-sm" style="background-color: ${colors.bgTertiary};"></div>
                                </div>
                            </div>
                            <p class="mt-2 text-sm font-semibold text-center" style="color: ${colors.textPrimary};">${theme.name}</p>
                        </button>
                    `;
                }).join('');
            }

            // --- START THE APP ---
            initialize();
        });
    </script>
</body>
</html>
